---
title: "MVCAA Tutorial 1: Creating PAT Data"
author: "Mazama Science"
date: "2023-07-18"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{MVCAA Tutorial 1: Creating PAT Data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(fig.width = 7, fig.height = 5)
```

## Introduction

This tutorial demonstrates how to create files containing _pas_, _pat_ and
_monitor_ data for a  particular community and how to save and access these files
in a local directory. Target audiences include grad students, researchers, air 
quality professionals and any member of the public concerned about air quality 
and comfortable working with R and RStudio.

## Goal

Our goal in this tutorial is to create _pas_, _pat_ and _monitor_ data objects 
for a single month for the Methow Valley -- a community in north-central 
Washington state.
[Clean Air Methow](https://www.cleanairmethow.org) 
operates as a project of the
[Methow Valley Citizens Council](http://mvcitizens.org)
and began deploying Purple Air Sensors in 2018:

> In the summer of 2018, Clean Air Methow launched the Clean Air Ambassador 
> Program, an exciting citizen science project, and one of the largest, rural 
> networks of low-cost sensors in the world!

This tutorial will demonstrate how to create usable data for this collection of
sensors for September, 2020 when the Methow Valley experienced poor air
quality due to wildfire smoke.

## Data Structures

_pas_ objects in the **AirSensor** package contain per-instrument 
metadata for a collection of PurpleAir sensors. This will include both "spatial 
metadata" like longitude, latitude, timezone, _etc._ as well as each instrument's 
`sensor_index`, allowing us to request timeseries data from the PurpleAir API.

_pat_ objects in the **AirSensor** package contain time-invariant 
spatial metadata for a single sensor as well as the time-dependent 
measurements made by that sensor.

_monitor_ objects in the **AirMonitor** package contain time-invariant 
spatial metadata for a multiple sensors as well as the time-dependent PM2.5  
measurements made by those sensors.

## Set the Archive Directory

Before you start, consider where on your computer you are going to save your data 
and create your archive. By default, these tutorials will save data underneath
your "home" directory.

Run `path.expand("~")` in the R console to see the location of your home directory. 
If you wish to save data somewhere else, you can specify an alternate location by 
modifying the code below. Otherwise you can jump to the next section.

```{r setup-data-directory, eval = FALSE, warning = FALSE, message = FALSE}
# Check your current home directory 
path.expand("~")

# Create your data directory anywhere you want, changing the home directory 
# part ("~") and keeping "Data/MVCAA".
#
# Windows example: archiveDir <- "C:/AirQuality/Data/MVCAA" 
#    UNIX example: archiveDir <- "/AirQuality/Data/MVCAA"

# The default choice places data underneath your home directory
archiveDir <- "~/Data/MVCAA" 
```

## Create a PurpleAirSynoptic (PAS) object

To find the sensors we wish to investigate, we must first create a _pas_ object 
with metadata for all PurpleAir senors in our target area. The Methow Valley 
valley is located entirely within Okanogan County, WA, so we can create an
Okanogan-only _pas_ object as our starting point.

```{r okanogan_pas, eval = TRUE, warning = FALSE, message = FALSE}
# AirSensor2 package
library(AirSensor2)

# Get user's PurpleAir_API_READ_KEY
###source('global_vars.R')

# Initialize spatial datasets
initializeMazamaSpatialUtils()

# Create a new 'pas' object for Okanogan county
okanogan_pas <-
  pas_createNew(
    api_key = PurpleAir_API_READ_KEY,
    countryCodes = "US",
    stateCodes = "WA",
    counties = c("Okanogan"),
    lookbackDays = 365,         # all sensors from the past year
    location_type = 0           # outdoor sensors only
  )

# Interactive map
okanogan_pas %>% pas_leaflet()
```

### Explore available sensors

Clicking on some of the sensors in the Methow Valley, it quickly becomes 
apparent that many of those sensors have a label that associates them with the
"Clean Air Ambassador" program. Unfortunately, the naming is not consistent.

A quick review of `sort(pas$locationName)` shows:

* "Clean Air Ambassador @..."
* "MV Ambassador @..."
* "MV Ambassadors@..."
* "MV Clean Air Abassador @..."
* "MV Clean Air Ambassador @..."
* "MV Clean Air Ambassador-..."
* "MVCC Ambassador @..."
* "MVCC Ambassador@..."

Clearly, some effort was made to systematize the naming even if it wasn't 
entirely successful. Nevertheless, we can filter for all location names that
begin with "MV" or "Clean Air" to create a MVCAA-only _pas_ object

```{r mvcaa_pas, eval = TRUE, warning = FALSE, message = FALSE}
mvcaa_pas <-
  okanogan_pas %>%
  pas_filter(stringr::str_detect(locationName, "^MV|^Clean Air"))

# Save this to our data directory
###save(mvcaa_pas, file = file.path(archiveDir, "mvcaa_pas.rda"))

# Interactive map
mvcaa_pas %>% pas_leaflet()
```

## Create a PurpleAirTimeseries (PAT) object

A _pat_ object contains time series data for a specific sensor. The
`pat_createNew()` function downloads all data records for a sensor -- typically
every 2 minutes. The `pat_createHourly()` function, downloads hourly aggregated
data as provided by the PurpleAir API. Here we will take a look at both.

### Raw Data

The `pat_createNew()` function has a `fields` argument that lets you specify
which data fields should be included in the result. But default, it uses all
those defined in `PurpleAir_HISTORY_PM25_FIELDS`:

```{r PurpleAir_HISTORY_PM25_FIELDS, eval = TRUE, echo = FALSE}
PurpleAir_HISTORY_PM25_FIELDS %>%
  stringr::str_split_1(',')
```

Clicking on the leaflet map above, we identify the `sensor_index` for the
"Winthrop Library" sensor as `"13681"`. The following chunk of code creates
a raw _pat_ object for this sensor and explores some of the 
"raw", or "engineering" parameters:

```{r Grizzly_Mtn_Outside, eval = TRUE, warning = FALSE, message = FALSE}
# Create raw pat object
pat <-
  pat_createNew(
    api_key = PurpleAir_API_READ_KEY,
    pas = mvcaa_pas,
    sensor_index = "13681",
    startdate = "2023-07-16",
    enddate = "2023-07-18",
    timezone = "UTC",
    verbose = TRUE
  )

# Pull out data
tbl <- pat$data

# Rewview parameters
names(tbl)

# NOTE:  Using "pch = 15" greatly improves the speed of drawing

# Sensor Electronics
plot(tbl[,c(1,2:5)], pch = 15, cex = 0.5, main = "Sensor Electronics")

# Atmospheric Variables
plot(tbl[,c(1,6:8)], pch = 15, cex = 0.5, main = "Atmospheric Variables")

# PM2.5 "atm"
plot(tbl[,c(1,12:14)], pch = 15, cex = 0.5, main = "PM2.5 'atm'")

# PM2.5 comparison
plot(tbl[,c(1,9,12,15)], pch = 15, cex = 0.5, main = "PM2.5 'alt' vs 'atm' vs 'cf1'")
```


